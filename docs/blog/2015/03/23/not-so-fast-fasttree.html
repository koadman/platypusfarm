<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width initial-scale=1">

  <title>Not so fast, FastTree</title>
  <meta name="description" content="important: see update at bottom of page Recently, much of the microbiology world has been sucked into a vortex called genomic epidemiology.This is not entire...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://darlinglab.org/blog/2015/03/23/not-so-fast-fasttree.html">
  <link rel="alternate" type="application/atom+xml" title="the Darling lab | computational (meta)genomics" href="https://darlinglab.org/feed.xml" />
  <link rel="shortcut icon" href="/site32.jpg" />
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">the Darling lab | computational (meta)genomics</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
          <a class="page-link" href="/mauve/mauve.html">Mauve</a>
          
        
          
        
          
          <a class="page-link" href="/openings/">Openings</a>
          
        
          
        
          
          <a class="page-link" href="/people/">People</a>
          
        
          
        
          
          <a class="page-link" href="/projects/">Projects</a>
          
        
          
          <a class="page-link" href="/publications/">Publications</a>
          
        
          
        
          
          <a class="page-link" href="/reviews/">Reviews</a>
          
        
          
        
          
          <a class="page-link" href="/software/">Software</a>
          
        
          
        
          
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Not so fast, FastTree</h1>
    <p class="post-meta">Mar 23, 2015</p>
  </header>

  <article class="post-content">
    <p><strong>important: see update at bottom of page</strong> Recently, much of the microbiology world has been sucked into a vortex called genomic epidemiology.
This is not entirely a bad thing. Genomic data can be orders of magnitude more informative than MLST data when it comes to inferring the ancestry of an isolated microbe. Genomic data gives information on gene content. And with bacterial whole genome sequencing costs approaching parity with the cost of MLST, why sequence a few genes when you could have whole genomes? Indeed these are exciting times for microbiology. But wait, there’s a fly in the ointment.</p>

<p>The typical genomic epidemiology workflow goes something like this:</p>

<ol>
  <li>sequence genomic DNA from a bunch of cultured isolates</li>
  <li>map each isolate’s reads to a closely related reference genome</li>
  <li>call variants relative to the reference</li>
  <li>format the variants and (hopefully!) invariant sites into a multiple alignment</li>
  <li>Infer a phylogeny</li>
  <li>Interpret the phylogeny</li>
</ol>

<p>Much has been written about potential pitfalls in each stage of this process.
For an overview of some of the issues I like <a href="http://www.ncbi.nlm.nih.gov/pubmed/24600054">the REALPHY paper</a>.
It describes the problems with leaving out invariant sites, discusses pitfalls of using a single reference genome, and even touches on the thorny issue of recombination, albeit without presenting a solution. That said, I think their software implementation leaves a bit to be desired, and <a href="https://bacpathgenomics.wordpress.com/2014/03/25/are-we-doing-fakephy-realphy-paper-in-mbe-and-the-inaccuracy-of-phylogenies-based-on-whole-genome-snps-identified-by-mapping-to-a-reference/">Kat Holt’s blog post</a> is worth reading for a balanced view on the single reference issue. The sky is not falling.</p>

<p>Last year a student I work with became involved in a genomic epidemiology project.
After following a simplified genomic epidemiology workflow that carries out <a href="http://darlinglab.org/tutorials/marker_phylogeny/">marker gene phylogeny based on the PhyloSift software</a>, the student had an alignment with 21,327 columns which fall into 630 different site patterns.
At my suggestion the student then applied <a href="http://microbesonline.org/fasttree/">the FastTree software</a> to infer a phylogeny of the isolates.
We used version 2.1.7. Et voilà, 55 seconds later we got a phylogeny(*):</p>

<p><img src="/assets/data/anonymous-2.1.7.png" alt="A bacterial genome phylogeny inferred with FastTree 2.1.7" /></p>

<p>Look at that tree. Just look at it.</p>

<p>Does something look funny to you? The taxon names perhaps?</p>

<p>Look at those nice step-like internal branches in the lower half of the tree, and remember that branch lengths are given as substitutions per site – because we’re not cladists and <em>this ain’t no freakin’ cladogram</em>.
If those branch lengths are to be believed, we have quite possibly discovered a wholly new evolutionary process. A process that regularly gives rise to divergence events after an exact number of mutations have occurred. Incredible! Stockholm is calling! Either that, or we have an inference problem. Hmmm…</p>

<p>Let’s dig a little deeper. What if we change the substitution model, does the tree change? What if we change the inference algorithm? We had RAxML handy so we gave that a go, and got the following tree:</p>

<p><img src="/assets/data/anonymous-RAxML.png" alt="A phylogeny inferred with RAxML on the same alignment" /></p>

<p>Hmmm.</p>

<p>What’s going on here? Which tree is right? To get some basic idea of this, Matt DeMaere (who works with me at UTS) and I had a look at how the cophenetic matrices compare to raw pairwise distance matrices derived from the genome alignments. Matt used the <a href="http://cran.r-project.org/web/packages/ape/index.html">APE package</a> from R to calculate <a href="http://svitsrv25.epfl.ch/R-doc/library/ape/html/cophenetic.phylo.html">cophenetic matrices</a> from the inferred trees. Doing the comparison between the FastTree 2.1.7 cophenetic matrix, the RAxML cophenetic matrix, and the raw distance matrix, we find that the RAxML tree matches the raw distances much better than the FastTree 2.1.7 tree does.</p>

<p>At this stage we became concerned. After all, the venerable FastTree program is in wide use, so how could it produce such erratic results? I headed over to the FastTree web site to see if there was any documentation on the issue; any indication of a bug or a bugfix. And there, in bold header about 75% of the way down the very long page, is a section entitled <a href="http://microbesonline.org/fasttree/#BranchLen"><strong>Why does FastTree report so many branch lengths of 0.0005 or 0.0001, or even negative branch lengths?</strong></a>
And there it was. The answer. It turns out FastTree by default uses single precision arithmetic and has a hard-coded limit on branch length precision. If you have data with branch lengths near that precision limit, they will either get rounded to 0 or the limit, e.g. 0.0001. This is a serious issue for many genomic epidemiology studies, where it is not uncommon to observe divergence among isolates on the order of 0.00001 to 0.0001 substitutions per site. Fortunately, the issue is easily resolved. There are a few places in the code that can be edited to enable double precision arithmetic and reduce the hard-coded limit on precision to a more reasonable value. The code diff is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--- FastTree-2.1.7.c	2013-01-30 07:22:04.000000000 +1100
+++ FastTree_accu.c	2015-03-24 11:59:34.447129977 +1100
@@ -1,4 +1,10 @@
 /*
+ * 2014/12/11 - Modifications to raise the precision of branch length
+ *              estimation. This should accompany setting USE_DOUBLE.
+ *              Search tolerances have been decreased to 1e-9 from 
+ *              their original 1e-4.
+ *
+ * 
  * FastTree -- inferring approximately-maximum-likelihood trees for large
  * multiple sequence alignments.
  *
@@ -852,10 +858,13 @@
    were increased to prevent numerical problems in rare cases.
    If compiled with -DUSE_DOUBLE then these minimums could be decreased.
 */
-const double MLMinBranchLengthTolerance = 1.0e-4; /* absolute tolerance for optimizing branch lengths */
+const double MLMinBranchLengthTolerance = 1.0e-9; /* absolute tolerance for optimizing branch lengths */
 const double MLFTolBranchLength = 0.001; /* fractional tolerance for optimizing branch lengths */
-const double MLMinBranchLength = 5.0e-4;
-const double MLMinRelBranchLength = 2.5e-4; /* minimum of rate * length */
+const double MLMinBranchLength = 5.0e-9;
+const double MLMinRelBranchLength = 2.5e-9; /* minimum of rate * length */
+
+const double fPostTotalTolerance = 1.0e-20; /* mzd 2015/01/06, added as original assertion is violated when 
+	                                           MLMMinBranchLengthTolerance is decreased to 1e-9. */
 
 int mlAccuracy = 1;		/* Rounds of optimization of branch lengths; 1 means do 2nd round only if close */
 double closeLogLkLimit = 5.0;	/* If partial optimization of an NNI looks like it would decrease the log likelihood
@@ -4962,7 +4971,7 @@
       double fPostTot = 0;
       for (j = 0; j &lt; 4; j++)
 	fPostTot += fPost[j];
-      assert(fPostTot &gt; 1e-10);
+      assert(fPostTot &gt; fPostTotalTolerance);
       double fPostInv = 1.0/fPostTot;
 #if 0 /* SSE3 is slower */
       vector_multiply_by(fPost, fPostInv, 4);
@@ -5025,7 +5034,7 @@
 	fPost[j] = value &gt;= 0 ? value : 0;
       }
       double fPostTot = vector_sum(fPost, 20);
-      assert(fPostTot &gt; 1e-10);
+      assert(fPostTot &gt; fPostTotalTolerance);
       double fPostInv = 1.0/fPostTot;
       vector_multiply_by(/*IN/OUT*/fPost, fPostInv, 20);
       int ch = -1;		/* the dominant character, if any */
</code></pre></div></div>

<p>These changes set the resolution limit to about 1 substitution per billion sites, which seems ample for bacteria that typically have genome sizes up to around 10 million nucleotides. It’s then necessary to compile the code with -DUSE_DOUBLE, e.g. <code class="language-plaintext highlighter-rouge">gcc -DUSE_DOUBLE -O3 -finline-functions -funroll-loops -Wall -o FastTree-2.1.7 FastTree-2.1.7.c -lm</code></p>

<p>Let’s see how our tree looks after making these changes:</p>

<p><img src="/assets/data/anonymous_2.1.7_precise.png" alt="A phylogeny inferred with double precision FastTree on the same alignment" /></p>

<p>Now that looks better! And a comparison of the cophenetic matrix to the raw distances looks good too.
Another way to check whether we’ve improved model fit is to run FastTree with the -gamma option, so that the log likelihoods reported can be compared across two different runs. If we do this with the vanilla FastTree-2.1.7 it reports <code class="language-plaintext highlighter-rouge">Gamma(20) LogLk = -40634.725</code>. Running the same analysis with the modified double-precision FastTree yields <code class="language-plaintext highlighter-rouge">Gamma(20) LogLk = -40182.654</code>. In other words, the tree inferred by the double precision version is about <code class="language-plaintext highlighter-rouge">e^452</code> times more likely to have generated the observed data. That’s no small improvement in model fit. Interestingly, the double-precision build actually runs faster than the single precision build on this dataset and on my laptop, so it seems the sacrifice of precision didn’t even buy us a speedup.</p>

<p>Perhaps this is just a case of RTFM. But how many of us actually do that? In retrospect I feel we were lucky to have identified this issue relatively early on in our data analysis. If the dataset were different, without so many genomes having divergences right around the limit of FastTree’s precision, the problem might have gone entirely unnoticed. That’s not to say it would be unimportant, though, because even just a few branches with such imprecise length estimates could in principle yield substantially reduced model fit. I am not sure to what extent this could lead to topological inaccuracy as well, but it does seem possible. Of course these issues of precision might be rather trivial compared to the effects of model misspecification, e.g. fitting a tree to a dataset with a substantial number of sites affected by recombination, and there are other tools like <a href="http://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1004041">ClonalFrameML</a> that implement models which address that issue. That said, even if the model is wrong (and when analyzing real data the model is wrong by definition) I’d like to have the best possible fit to the data. Wouldn’t you?</p>

<p>Thanks to <a href="https://scholar.google.com.au/citations?user=hQTEUsIAAAAJ&amp;hl=en&amp;oi=ao">Matt DeMaere</a> for assistance preparing this blog post.</p>

<p>(*) Note that isolate names have been anonymized to protect the innocent.</p>

<h3 id="update-25th-march-2015">Update: 25th March 2015</h3>

<p>Morgan Price emailed to let me know that the above described changes, along with some others, have been incorporated into version 2.1.8 of FastTree. It’s available from the <a href="http://microbesonline.org/fasttree/">usual place</a>. The increased precision is not enabled in the precompiled binaries, e.g. it’s still necessary to build with <code class="language-plaintext highlighter-rouge">-DUSE_DOUBLE</code>, but the precompiled binary supplies some helpful warning messages to let users know if their data may be in the danger zone:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WARNING! This alignment consists of closely-related and very-long sequences.
This version of FastTree may not report reasonable branch lengths!
Consider recompiling FastTree with -DUSE_DOUBLE.
For more information, visit
http://www.microbesonline.org/fasttree/#BranchLen

WARNING! FastTree (or other standard maximum-likelihood tools)
may not be appropriate for aligments of very closely-related sequences
like this one, as FastTree does not account for recombination or gene conversion
</code></pre></div></div>

<p>Happy FastTreeing!</p>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>the Darling lab | computational (meta)genomics</li>
          <li><a href="mailto:aaron.darling@uts.edu.au">aaron.darling@uts.edu.au</a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/koadman">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">koadman</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/koadman">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">koadman</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">The Darling lab at the University of Technology Sydney. We develop computational and molecular techniques to characterize the hidden world of microbes.
</p>
      </div>
    </div>
    <img alt="tree of bacterial and archaeal life, showing human gut lineages in blue" src="/assets/tree.png">

  </div>
</footer>


  </body>

</html>
